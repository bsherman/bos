---
name: Build bOS Images
on:  # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      image_flavor:
        type: string
concurrency:
  group: >-
    ${{ github.workflow }}-${{ github.ref
    || github.run_id }}-${{ inputs.image_flavor }}
  cancel-in-progress: true
env:
  IMAGE_REGISTRY: ghcr.io/bsherman
  IMAGE_NAME: bos
  SET_X: 1
jobs:
  get-images:
    name: Get ${{ inputs.image_flavor }} Images for Build
    outputs:
      images: ${{ steps.images.outputs.images }}
      multi_arch_images: ${{ steps.images.outputs.multi_arch_images }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Get Images for Build
        id: images
        uses: ./.github/actions/get-images
        with:
          image_flavor: ${{ inputs.image_flavor }}
  build-image:
    name: >-
      Build ${{ inputs.image_flavor }} Images
      (${{ matrix.combo.image }}/${{ matrix.combo.arch }})
    needs: get-images
    runs-on: ${{ matrix.combo.runner }}
    continue-on-error: false
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        combo: ${{ fromJson(needs.get-images.outputs.images) }}
    steps:
      - name: Checkout
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493  # v4

      - name: Install Just
        uses: ./.github/actions/install-just

      - name: Show disk space (before cleanup)
        run: sudo df -h

      - name: Check if /mnt is there
        id: check_mnt
        run: |
          if sudo mountpoint /mnt; then
            echo "mnt_is_there=1" >>$GITHUB_OUTPUT
          else
            echo "mnt_is_there=0" >>$GITHUB_OUTPUT
          fi

      - name: Free Disk Space (Ubuntu)
        if: ${{ steps.check_mnt.outputs.mnt_is_there == '1' }}
        # v1.3.1
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be

      - name: Mount BTRFS for podman storage
        uses: ublue-os/container-storage-action@main
        if: ${{ steps.check_mnt.outputs.mnt_is_there == '1' }}
        with:
          target-dir: /var/lib/containers

      - name: Show disk space (after cleanup)
        run: sudo df -h

      - name: Build Image
        shell: bash
        run: |
          # note: if disabling rechunker, must also disable sudo call
          # just build ${{ matrix.combo.image }}
          sudo just build ${{ matrix.combo.image }}

      - name: Rechunk Image
        shell: bash
        run: |
          sudo just rechunk ${{ matrix.combo.image }}

      - name: Load and Tag Image
        shell: bash
        run: |
          just load-image ${{ matrix.combo.image }}

      - name: Get Tags
        id: get_tags
        shell: bash
        run: |
          tags=$(just get-tags ${{ matrix.combo.image }})
          echo "tags=$tags" >> $GITHUB_OUTPUT
          echo $GITHUB_OUTPUT

      - name: Compute Push Tags
        id: push_tags
        shell: bash
        run: |
          TAGS="${{ steps.get_tags.outputs.tags }}"
          MULTI_ARCH='${{ needs.get-images.outputs.multi_arch_images }}'
          IMAGE="${{ matrix.combo.image }}"
          ARCH="${{ matrix.combo.arch }}"
          IS_MULTI=$(echo "$MULTI_ARCH" | \
            jq -r --arg img "$IMAGE" 'any(.[]; . == $img)')
          if [[ "$IS_MULTI" == "true" ]]; then
            # Append -<arch> to each tag
            SUFFIXED=""
            for tag in $TAGS; do
              SUFFIXED+="${tag}-${ARCH} "
            done
            TAGS="${SUFFIXED% }"
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "is_multi_arch=$IS_MULTI" >> $GITHUB_OUTPUT

      # NOTE: disabled secureboot check since bluefin LTS will never pass
      # - name: Check Secureboot
      #  id: secureboot
      #  shell: bash
      #  run: |
      #    just secureboot ${{ matrix.combo.image }}
      - name: Lowercase Registry
        id: registry_case
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ env.IMAGE_REGISTRY }}
      - name: Push to GHCR
        uses: Wandalen/wretry.action@v3.8.0
        id: push
        if: >-
          contains(fromJson('["workflow_dispatch", "merge_group"]'),
          github.event_name) || github.event.schedule == '41 6 * * 0'
        env:
          REGISTRY_USER: ${{ github.actor }}
          REGISTRY_PASSWORD: ${{ github.token }}
        with:
          action: redhat-actions/push-to-registry@v2
          attempt_limit: 3
          attempt_delay: 15000
          with: |
            image: ${{ env.IMAGE_NAME }}
            tags: ${{ steps.push_tags.outputs.tags }}
            registry: ${{ steps.registry_case.outputs.lowercase }}
            username: ${{ env.REGISTRY_USER }}
            password: ${{ env.REGISTRY_PASSWORD }}
            extra-args: |
              --disable-content-trust
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        if: >-
          (contains(fromJson('["workflow_dispatch", "merge_group"]'),
          github.event_name) || github.event.schedule == '41 6 * * 0')
          && steps.push_tags.outputs.is_multi_arch != 'true'
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0
        with:
          cosign-release: 'v2.6.1'
        if: >-
          (contains(fromJson('["workflow_dispatch", "merge_group"]'),
          github.event_name) || github.event.schedule == '41 6 * * 0')
          && steps.push_tags.outputs.is_multi_arch != 'true'
      - name: Sign Container Image
        if: >-
          (contains(fromJson('["workflow_dispatch", "merge_group"]'),
          github.event_name) || github.event.schedule == '41 6 * * 0')
          && steps.push_tags.outputs.is_multi_arch != 'true'
        run: |
          REGISTRY="${{ steps.registry_case.outputs.lowercase }}"
          cosign sign -y --key env://COSIGN_PRIVATE_KEY \
              "${REGISTRY}/${{ env.IMAGE_NAME }}@${TAGS}"
        env:
          TAGS: >-
            ${{ steps.push.outputs.outputs
            && fromJSON(steps.push.outputs.outputs).digest }}
          COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
  create-manifest:
    name: Create Manifest (${{ matrix.image }})
    needs: [get-images, build-image]
    if: >-
      (contains(fromJson('["workflow_dispatch", "merge_group"]'),
      github.event_name) || github.event.schedule == '41 6 * * 0')
      && needs.get-images.outputs.multi_arch_images != '[]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.get-images.outputs.multi_arch_images) }}
    steps:
      - name: Lowercase Registry
        id: registry_case
        uses: ASzc/change-string-case-action@v6
        with:
          string: ${{ env.IMAGE_REGISTRY }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Get Version Tag
        id: version
        run: |
          REGISTRY="${{ steps.registry_case.outputs.lowercase }}"
          # Inspect x86_64 image to get the version tag
          IMG="${REGISTRY}/${{ env.IMAGE_NAME }}"
          VERSION=$(skopeo inspect \
            --creds \
            "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
            "docker://${IMG}:${{ matrix.image }}-x86_64" \
            | jq -r \
            '.Labels["org.opencontainers.image.version"]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Create and Push Manifests
        run: |
          REGISTRY="${{ steps.registry_case.outputs.lowercase }}"
          IMAGE="${REGISTRY}/${{ env.IMAGE_NAME }}"
          VERSION="${{ steps.version.outputs.version }}"

          # Create manifest for image name tag
          docker manifest create \
            "${IMAGE}:${{ matrix.image }}" \
            "${IMAGE}:${{ matrix.image }}-x86_64" \
            "${IMAGE}:${{ matrix.image }}-aarch64"
          docker manifest push "${IMAGE}:${{ matrix.image }}"

          # Create manifest for version tag
          docker manifest create \
            "${IMAGE}:${VERSION}" \
            "${IMAGE}:${VERSION}-x86_64" \
            "${IMAGE}:${VERSION}-aarch64"
          docker manifest push "${IMAGE}:${VERSION}"
      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0
        with:
          cosign-release: 'v2.6.1'
      - name: Sign Manifests
        run: |
          REGISTRY="${{ steps.registry_case.outputs.lowercase }}"
          IMAGE="${REGISTRY}/${{ env.IMAGE_NAME }}"
          VERSION="${{ steps.version.outputs.version }}"

          # Sign image name manifest
          DIGEST=$(skopeo inspect --raw \
            --creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
            "docker://${IMAGE}:${{ matrix.image }}" \
            | sha256sum | awk '{print "sha256:"$1}')
          cosign sign -y --key env://COSIGN_PRIVATE_KEY \
            "${IMAGE}@${DIGEST}"

          # Sign version manifest
          DIGEST=$(skopeo inspect --raw \
            --creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
            "docker://${IMAGE}:${VERSION}" \
            | sha256sum | awk '{print "sha256:"$1}')
          cosign sign -y --key env://COSIGN_PRIVATE_KEY \
            "${IMAGE}@${DIGEST}"
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
  check:
    name: Check Build ${{ inputs.image_flavor }} Images Successful
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    needs: [build-image, create-manifest]
    steps:
      - name: Exit on failure
        if: >-
          ${{ contains(fromJson('["failure", "skipped"]'),
          needs.build-image.result)
          || needs.create-manifest.result == 'failure' }}
        shell: bash
        run: exit 1
      - name: Exit
        shell: bash
        run: exit 0
